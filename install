#!/bin/bash
set -e

echo "================="
echo "Updating packages"
sudo dnf -y install dnf-plugins-core

echo "================="
echo "Adding repositories"
sudo dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc

sudo dnf copr enable mbitard/sway -y
sudo dnf copr enable embik/wayland-desktop -x sway -x swayidle -x swaylock -x wlroots -y

echo "================="
echo "Installing packages"
sudo dnf install --refresh -y --allowerasing \
  GConf2 \
  NetworkManager \
  NetworkManager-wifi \
  autoconf \
  automake \
  bzip2 \
  cmake \
  ctags \
  docker \
  exa \
  expect \
  fedora-workstation-repositories \
  firefox \
  fuse-sshfs \
  gcc-c++ \
  gnome-keyring \
  grim \
  htop \
  httpie \
  jq \
  keepassxc \
  keychain \
  lcov \
  libffi-devel \
  libnotify \
  libtool \
  libxslt-devel \
  libyaml-devel \
  light \
  mako \
  ncurses-devel \
  nodejs \
  nodejs-yarn \
  openssl-devel \
  pavucontrol \
  postgresql-contrib \
  postgresql-server \
  powerline-fonts \
  pulseaudio \
  pulseaudio-utils \
  python3 \
  python3-udiskie \
  qterminal \
  ranger \
  readline-devel \
  rofi \
  snap \
  slurp \
  sway \
  swayidle \
  swaylock \
  syncthing \
  unixODBC-devel \
  util-linux-user \
  vim \
  w3m \
  w3m-img \
  zip \
  zsh

sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 1

sudo ln -sf /usr/bin/nodejs-yarn /usr/local/bin/yarn

sudo dnf config-manager --set-enabled google-chrome
sudo dnf install -y google-chrome-stable

sudo ln -s /var/lib/snapd/snap /snap
sudo snap install spotify
sudo snap install vscode --classic
sudo snap install slack --classic
sudo snap install mailspring --classic
sudo snap install mattermost-desktop
sudo snap install figma-linux --beta

echo "================="
echo "Installing Firefox developer edition"
http -d --output /tmp/firefox-developer.tar.bz2 GET 'https://download.mozilla.org/?product=firefox-devedition-latest-ssl&os=linux64&lang=en-US'
sudo tar -C /opt -xjf /tmp/firefox-developer.tar.bz2
sudo ln -sf /opt/firefox/firefox /usr/local/bin/ff-dev

echo "================="
echo "Installing keybase"
if [[ ! -x "$(command -v keybase)" ]]; then
 sudo dnf install -y https://prerelease.keybase.io/keybase_amd64.rpm
fi

echo "=============="
echo "Install fira code font"
./install_fira_font

echo "================="
echo "Installing Development libraries and tools"
sudo dnf group install -y "Development Libraries" "Development Tools"

echo "================="
echo "Enabling and starting docker daemon"
if getent group docker; then
  echo "docker group exist"
else
  sudo groupadd docker
fi
sudo usermod -aG docker "$USER"
sudo systemctl enable docker
sudo systemctl start docker

mkdir -p $HOME/.local/bin

echo "================="
echo "Installing python packages"
pip3 install --upgrade --user \
  awscli \
  flake8 \
  boto \
  gnupg \
  hvac \
  minio \
  pip \
  psutil \
  netifaces \
  consulate \
  pywal \
  python-language-server \
  pyflakes \
  udiskie \
  yapf


echo "================="
echo "Installing asdf"
if [ -d ~/.asdf/.git ]; then
  . ~/.asdf/asdf.sh
  asdf update
else
  git clone https://github.com/asdf-vm/asdf.git ~/.asdf
  cd ~/.asdf
  git checkout "$(git describe --abbrev=0 --tags)"
  cd -
fi
. ~/.asdf/asdf.sh

echo "================="
echo "Installing erlang/elixir"
asdf plugin-add erlang https://github.com/asdf-vm/asdf-erlang.git \
  && asdf plugin-add elixir https://github.com/asdf-vm/asdf-elixir.git

asdf plugin-add vault https://github.com/Banno/asdf-hashicorp.git && \
asdf install vault 0.9.5 && \
asdf global vault 0.9.5 && \

echo "================="
echo "Installing Helm, Kops, Kubectl"
http -d -o /tmp/kops GET https://github.com/kubernetes/kops/releases/download/1.10.0/kops-linux-amd64 
http -d -o /tmp/kubectl GET https://storage.googleapis.com/kubernetes-release/release/v1.10.0/bin/linux/amd64/kubectl
http -d -o /tmp/helm GET https://kubernetes-helm.storage.googleapis.com/helm-v2.7.2-linux-amd64.tar.gz
cd /tmp
tar xvzf helm
sudo cp kops /usr/bin/kops
sudo cp kubectl /usr/bin/kubectl
sudo cp linux-amd64/helm /usr/bin/helm
sudo chmod +x /usr/bin/kops
sudo chmod +x /usr/bin/kubectl
sudo chmod +x /usr/bin/helm
cd -

echo "================="
echo "Installing Zprezto"
if [ ! -d "$HOME/.zprezto" ]; then
	git clone --recursive https://github.com/AlexDouze/prezto.git "${ZDOTDIR:-$HOME}/.zprezto"
fi
if [ ! -d "$HOME/.zprezto-contrib" ]; then
  git clone --recursive https://github.com/AlexDouze/prezto-contrib.git "${ZDOTDIR:-$HOME}/.zprezto-contrib"
fi

echo "================="
echo "Setting up Syncthing service"
mkdir -p $HOME/.config/systemd/user/
sudo wget -O $HOME/.config/systemd/user/syncthing.service https://raw.githubusercontent.com/syncthing/syncthing/master/etc/linux-systemd/user/syncthing.service
systemctl --user enable syncthing.service
systemctl --user start syncthing.service

echo "================="
echo "Setting up keychain service"
mkdir -p $HOME/.config/systemd/user
ln -sf $PWD/services/keychain.service $HOME/.config/systemd/user/keychain.service
systemctl --user enable keychain
systemctl --user start keychain

echo "================="
echo "Installing and setting up Greenclip service"
sudo wget https://github.com/erebe/greenclip/releases/download/3.0/greenclip -O /usr/bin/greenclip
sudo chmod +x /usr/bin/greenclip
ln -sf $PWD/services/greenclip.service $HOME/.config/systemd/user/greenclip.service
systemctl --user enable greenclip
systemctl --user start greenclip

echo "================="
echo "Enabling ssh-agent service"
ln -sf $PWD/services/ssh-agent.service $HOME/.config/systemd/user/ssh-agent.service
ln -sf $PWD/config/pam_environment $HOME/.pam_environment
ln -sf $PWD/config/ssh_config $HOME/.ssh/config
systemctl --user enable ssh-agent
systemctl --user start ssh-agent

echo "================="
echo "Creating symlinks for config files"

echo "Create symlink for zprezto configuration"
mkdir -p $HOME/.zshrc.d
ln -sf $PWD/config/zpreztorc $HOME/.zpreztorc
ln -sf $PWD/config/zshrc $HOME/.zshrc
ln -sf $PWD/config/yarn-completion.bash $HOME/.zshrc.d/
ln -sf $PWD/config/dircolors-solarized.ansi-light $HOME/.zshrc.d/

echo "Create symlink for gitconfig"
ln -sf $PWD/config/gitconfig $HOME/.gitconfig
ln -sf $PWD/config/gitignore $HOME/.gitignore

echo "Create symlink for vim"
ln -sf $PWD/vim/vimrc $HOME/.vimrc
rm -rf $HOME/.vim
ln -sf $PWD/vim/vim $HOME/.vim

echo "Create symlink for sway"
mkdir -p $HOME/.config/sway
ln -sf $PWD/config/sway-config $HOME/.config/sway/config
ln -sf $PWD/config/swaystatus.conf $HOME/.swaystatus.conf

echo "Create symlink for ranger"
ln -sf $PWD/config/ranger $HOME/.config/ranger

echo "Create symlink for .bin"
rm -rf $HOME/.bin
ln -sf $PWD/bin $HOME/.bin

echo "Create symlink for qterminal"
mkdir -p $HOME/.config/qterminal.org/
ln -sf $PWD/config/qterminal.ini $HOME/.config/qterminal.org/qterminal.ini

echo "fs.inotify.max_user_watches=524288" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p

echo "================="
echo "Changing default shell"
chsh -s /usr/bin/zsh
